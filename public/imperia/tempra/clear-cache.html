<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Cleaner - MainTick</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            text-align: center;
        }
        button {
            background: #30D058;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            margin: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            opacity: 0.8;
        }
        .status {
            margin: 20px 0;
            padding: 20px;
            background: #1C1C1E;
            border-radius: 10px;
            font-family: monospace;
            text-align: left;
            max-height: 400px;
            overflow: auto;
        }
        .error { color: #FF453A; }
        .success { color: #30D058; }
        .info { color: #007AFF; }
    </style>
</head>
<body>
    <h1>MainTick Cache Cleaner</h1>
    <p>Verwenden Sie diese Seite, um alle Caches zu löschen und Updates zu erzwingen.</p>
    
    <button onclick="clearAllCaches()">Alle Caches löschen</button>
    <button onclick="unregisterServiceWorkers()">Service Workers entfernen</button>
    <button onclick="forceReload()">Hard Reload</button>
    <button onclick="window.location.href='/maintick/stopwatch.html'">Zurück zu MainTick</button>
    
    <div class="status" id="status"></div>
    
    <script>
        const status = document.getElementById('status');
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            status.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            status.scrollTop = status.scrollHeight;
        }
        
        async function clearAllCaches() {
            log('Starte Cache-Löschung...', 'info');
            
            try {
                // Liste alle Caches auf
                const cacheNames = await caches.keys();
                log(`Gefundene Caches: ${cacheNames.join(', ')}`, 'info');
                
                // Lösche alle Caches
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`Cache gelöscht: ${cacheName}`, 'success');
                }
                
                // Clear localStorage
                localStorage.clear();
                log('LocalStorage gelöscht', 'success');
                
                // Clear sessionStorage
                sessionStorage.clear();
                log('SessionStorage gelöscht', 'success');
                
                log('Alle Caches erfolgreich gelöscht!', 'success');
            } catch (error) {
                log(`Fehler beim Löschen der Caches: ${error.message}`, 'error');
            }
        }
        
        async function unregisterServiceWorkers() {
            log('Entferne Service Workers...', 'info');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`Gefundene Service Workers: ${registrations.length}`, 'info');
                
                for (const registration of registrations) {
                    const success = await registration.unregister();
                    if (success) {
                        log(`Service Worker entfernt: ${registration.scope}`, 'success');
                    } else {
                        log(`Fehler beim Entfernen: ${registration.scope}`, 'error');
                    }
                }
                
                log('Alle Service Workers entfernt!', 'success');
            } catch (error) {
                log(`Fehler beim Entfernen der Service Workers: ${error.message}`, 'error');
            }
        }
        
        function forceReload() {
            log('Erzwinge Hard Reload in 2 Sekunden...', 'info');
            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }
        
        // Zeige aktuelle Status
        window.addEventListener('load', async () => {
            log('=== Cache Status ===', 'info');
            
            // Service Worker Status
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`Service Workers aktiv: ${registrations.length}`, 'info');
                
                // Cache Status
                const cacheNames = await caches.keys();
                log(`Caches vorhanden: ${cacheNames.length}`, 'info');
                if (cacheNames.length > 0) {
                    log(`Cache Namen: ${cacheNames.join(', ')}`, 'info');
                }
            } else {
                log('Service Workers nicht unterstützt', 'error');
            }
        });
    </script>
</body>
</html>