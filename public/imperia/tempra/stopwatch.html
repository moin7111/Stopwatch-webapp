<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="theme-color" content="#000000" />
	<meta name="apple-mobile-web-app-title" content="Tempra" />
	<meta name="application-name" content="Tempra" />
	<title>Tempra - Stoppuhr</title>
	<link rel="manifest" href="/imperia/manifest.json" />
	<link rel="apple-touch-icon" href="/icon-192x192.png" />
	<link rel="icon" type="image/png" href="/icon-192x192.png" />
	<link rel="stylesheet" href="/css/stopwatch-ui.css?v=2024011501">
	<link rel="apple-touch-startup-image" href="/icon-512x512.png">
</head>
<body>
	<div class="status-bar">
		<div id="statusText" style="height:20px;">&nbsp;</div>
	</div>

	<div class="stopwatch-container">
		<div class="time-display" id="timeDisplay">00:00,00</div>

		<div class="controls" aria-hidden="false">
			<button id="leftButton" class="control-button left left-idle" disabled>Runde</button>
			<button id="rightButton" class="control-button right right-start">Start</button>
			<div class="dots" aria-hidden="true">
				<div class="dot active"></div>
				<div class="dot"></div>
			</div>
		</div>

		<div class="separator-line" aria-hidden="true"></div>
		<div class="laps-container" id="lapsContainer"></div>
	</div>

	<div class="bottom-nav" role="navigation" aria-label="Uhr Navigation">
		<div class="nav-item" id="worldClockNavItem">
			<div class="nav-icon" aria-hidden="true">
				<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="12" cy="12" r="9"></circle>
					<path d="M12 3v18"></path>
					<path d="M12 3 C7.5 7.5, 7.5 16.5, 12 21"></path>
					<path d="M12 3 C16.5 7.5, 16.5 16.5, 12 21"></path>
					<path d="M5.2 7.2c2 1.2 6 1.8 13.6 0"></path>
					<path d="M4 12h16"></path>
					<path d="M5.2 16.8c2-1.2 6-1.8 13.6 0"></path>
				</svg>
			</div>
			<div>Weltuhr</div>
		</div>

		<div class="nav-item" id="alarmNavItem">
			<div class="nav-icon">
				<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
					<path d="M381.2 64.1c-1.3-.1-2.6-.1-3.9-.1h-.2c-16.2 0-32 5.4-44.6 15.1-1.6 1.3-2.6 3.2-2.7 5.2-.1 2 .8 4 2.3 5.4l89.8 80.5c1.3 1.1 2.9 1.8 4.6 1.8h.4c1.9-.1 3.6-1 4.8-2.4C440.9 159 448 150.8 448 133c.1-36.4-29.1-66.8-66.8-68.9zM64 133c0 17.8 7.1 26 16.3 36.6 1.2 1.4 2.9 2.3 4.8 2.4h.4c1.7 0 3.3-.6 4.6-1.8L180 89.7c1.5-1.4 2.4-3.3 2.3-5.4-.1-2-1-3.9-2.7-5.2C167 69.4 151.2 64 135 64h-.2c-1.3 0-2.6 0-3.9.1-37.7 2.1-67 32.5-66.9 68.9z"/>
					<g>
						<path d="M390 386c26.2-30.7 42-70.5 42-114 0-97.2-78.8-176-176-176S80 174.8 80 272c0 43.5 15.8 83.3 42 114l-34.7 35.5c-6.2 6.3-6 15.5.3 21.6 3.1 3 7.4 4.8 11.4 4.8 4.2 0 8.1-1.9 11.2-5.1l34.6-34.5c30.3 24.7 69 39.6 111.2 39.6s80.9-14.8 111.2-39.6l33.6 34.5c3.1 3.2 7.3 5.1 11.5 5.1 4 0 8.1-1.8 11.2-4.8 6.3-6.2 7.5-15.3 1.3-21.6L390 386zM270 274c0 7.7-6.3 14-14 14h-82c-7.7 0-14-6.3-14-14s6.3-14 14-14h68V158c0-7.7 6.3-14 14-14s14 6.3 14 14v116z"/>
					</g>
				</svg>
			</div>
			<div>Wecker</div>
		</div>

		<div class="nav-item active">
			<div class="nav-icon">
				<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
					<path d="M415.9 143.7c3.1 3.1 8.2 3.1 11.3 0l11.3-11.3c3.1-3.1 3.1-8.2 0-11.3L413 95.6c-3.1-3.1-8.2-3.1-11.3 0l-11.3 11.3c-3.1 3.1-3.1 8.2 0 11.3l25.5 25.5zM84.8 143.7c3.1 3.1 8.2 3.1 11.3 0l25.5-25.5c3.1-3.1 3.1-8.2 0-11.3l-11.3-11.3c-3.1-3.1-8.2-3.1-11.3 0L73.5 121c-3.1 3.1-3.1 8.2 0 11.3l11.3 11.4z"/>
					<path d="M280 81.5V64c0-8.8-7.2-16-16-16h-16c-8.8 0-16 7.2-16 16v17.5C137.3 93.3 64 174.1 64 272c0 106 86 192 192 192s192-86 192-192c0-97.9-73.3-178.7-168-190.5zm-10 219.3V320c0 7.7-6.3 14-14 14s-14-6.3-14-14v-19.2c-10.7-5.2-18-16.1-18-28.8s7.3-23.6 18-28.8V144c0-7.7 6.3-14 14-14s14 6.3 14 14v99.2c10.7 5.2 18 16.1 18 28.8s-7.3 23.6-18 28.8z"/>
				</svg>
			</div>
			<div>Stoppuhr</div>
		</div>

		<div class="nav-item">
			<div class="nav-icon">
				<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
					<path d="M256 456c-110.3 0-200-89.7-200-200 0-54.8 21.7-105.9 61.2-144 6.4-6.2 16.6-6 22.7.4 6.2 6.4 6 16.6-.4 22.7-33.1 32-51.3 74.9-51.3 120.9 0 92.5 75.3 167.8 167.8 167.8S423.8 348.5 423.8 256c0-87.1-66.7-159-151.8-167.1v62.6c0 8.9-7.2 16.1-16.1 16.1s-16.1-7.2-16.1-16.1V72.1c0-8.9 7.2-16.1 16.1-16.1 110.3 0 200 89.7 200 200S366.3 456 256 456z"/>
					<path d="M175.9 161.9l99.5 71.5c13.5 9.7 16.7 28.5 7 42s-28.5 16.7-42 7c-2.8-2-5.2-4.4-7-7l-71.5-99.5c-3.2-4.5-2.2-10.8 2.3-14 3.6-2.6 8.3-2.4 11.7 0z"/>
				</svg>
			</div>
			<div>Timer</div>
		</div>
	</div>

	<div class="home-indicator" aria-hidden="true"></div>

	<div class="dev-panel" id="devPanel">
		<input id="tokenInput" placeholder="Token (z.B. CZVOVZ)" />
		<div style="display:flex; gap:8px;">
			<button id="connectBtn">Verbinden</button>
			<button id="clearBtn" style="background:#FF6B6B">Trennen</button>
		</div>
		<div style="font-size:13px; opacity:0.8; margin-top:6px;">Tempra - Professionelle Stoppuhr-Steuerung</div>
	</div>

	<script src="/js/stopwatch-core.js?v=2024011501"></script>
	<script src="/js/manual-input.js?v=2024011501"></script>
	<script src="/js/stopwatch-api.js?v=2024011501"></script>
	<script src="/js/preset-manager.js?v=2024011501"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const stopwatch = new StopwatchCore();
			let api = null; window.api = null;

			stopwatch.initUI({
				timeDisplay: document.getElementById('timeDisplay'),
				leftButton: document.getElementById('leftButton'),
				rightButton: document.getElementById('rightButton'),
				lapsContainer: document.getElementById('lapsContainer'),
				statusText: document.getElementById('statusText')
			});

			// Triple-click Alarm -> Preset Manager
			let alarmTapCount = 0; let alarmTapTimer = null; let alarmLastTs = 0;
			document.getElementById('alarmNavItem').addEventListener('pointerdown', (e) => {
				const now = Date.now(); if (!e.isPrimary) return; if (now - alarmLastTs > 500) alarmTapCount = 0; alarmLastTs = now; alarmTapCount++;
				if (alarmTapCount === 3) { if (window.PresetManager) { window.PresetManager.open(stopwatch, api); } alarmTapCount = 0; }
				clearTimeout(alarmTapTimer); alarmTapTimer = setTimeout(()=>alarmTapCount=0,500);
			}, { passive: true });

			// Triple-click Weltuhr -> Routines
			let wcTapCount = 0; let wcTapTimer = null; let wcLastTs = 0;
			document.getElementById('worldClockNavItem').addEventListener('pointerdown', (e) => {
				const now = Date.now(); if (!e.isPrimary) return; if (now - wcLastTs > 500) wcTapCount = 0; wcLastTs = now; wcTapCount++;
				if (wcTapCount === 3) { window.location.href = '/imperia/control/index.html'; wcTapCount = 0; }
				clearTimeout(wcTapTimer); wcTapTimer = setTimeout(()=>wcTapCount=0,500);
			}, { passive: true });

			// Dev panel
			const params = new URLSearchParams(location.search);
			const dev = params.get('dev');
			const panel = document.getElementById('devPanel');
			const tokenInput = document.getElementById('tokenInput');
			const connectBtn = document.getElementById('connectBtn');
			const clearBtn = document.getElementById('clearBtn');
			if (dev === '1') panel.classList.add('show');

			connectBtn.addEventListener('click', function() {
				const token = tokenInput.value.trim();
				if (!token) return alert('Bitte Token eingeben');
				api = new StopwatchAPI(token, 'tempra'); window.api = api;
				api.startPolling(stopwatch);
				stopwatch.updateStatus(`Tempra verbunden (${token.substring(0,6)}...)`);
				localStorage.setItem('tempra_token', token);
			});
			clearBtn.addEventListener('click', function(){ if (api) { api.stopPolling(); api = null; window.api = null; } stopwatch.updateStatus('Getrennt'); });

			const tokenParam = params.get('token') || params.get('t') || localStorage.getItem('tempra_token');
			if (tokenParam) {
				api = new StopwatchAPI(tokenParam, 'tempra'); window.api = api;
				api.startPolling(stopwatch);
				stopwatch.updateStatus(`Tempra verbunden (${tokenParam.substring(0,6)}...)`);
				localStorage.setItem('tempra_token', tokenParam);
			}

			// Fullscreen & prevent accidental scroll/zoom
			function tryEnterFullscreen() {
				const el = document.documentElement;
				if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) return;
				const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen; if (fn) { try { fn.call(el); } catch(e){} }
			}
			const enterOnce = () => { tryEnterFullscreen(); document.removeEventListener('click', enterOnce); document.removeEventListener('touchstart', enterOnce); };
			document.addEventListener('click', enterOnce, { once: true });
			document.addEventListener('touchstart', enterOnce, { once: true });
			document.addEventListener('touchmove', function(e){ e.preventDefault(); }, { passive: false });
			let lastTouch = 0;
			document.addEventListener('touchend', function(e){ const now = Date.now(); if (now - lastTouch <= 300) e.preventDefault(); lastTouch = now; }, { passive: false });
			document.addEventListener('gesturestart', function(e){ e.preventDefault && e.preventDefault(); });
			document.addEventListener('dblclick', function(e){ e.preventDefault(); });
			window.addEventListener('keydown', function(e){ const keys = ['ArrowUp','ArrowDown','PageUp','PageDown','Home','End',' ']; if (keys.includes(e.key)) e.preventDefault(); }, { passive: false });

			// Service Worker: ensure latest
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.getRegistrations().then(function(regs){ for (let r of regs) { r.unregister(); } }).then(function(){
					return navigator.serviceWorker.register('/imperia/sw.js', { scope: '/imperia/' });
				}).then(function(reg){ reg.update(); setInterval(()=>reg.update(), 10000); }).catch(function(err){ console.log('SW failed', err); });
			}

			if (performance && performance.navigation && performance.navigation.type === 1) {
				if ('caches' in window) { caches.keys().then(function(names){ for (let name of names) { caches.delete(name); } }); }
			}
		});
	</script>
</body>
</html>