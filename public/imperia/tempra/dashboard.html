<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#000000" />
    <title>Tempra - Dashboard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/imperia/manifest.json" />
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/icon-192x192.png" />
    <link rel="icon" type="image/png" href="/icon-192x192.png" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <main style="padding:18px;max-width:900px;margin:28px auto;">
    <h1>üé© Dein Tempra Dashboard</h1>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:20px;">
      <button id="logoutBtn">Logout</button>
      <div style="color: #8e8e93; font-size: 14px;">Version: Beta 0.3</div>
    </div>

    <section style="margin-top:24px;">
      <h2>üì± Dein Token & API</h2>
      <div id="tokenInfo" style="background:#2a2a2a;padding:20px;border-radius:8px;margin:16px 0;">
        <div>Lade Token...</div>
      </div>
    </section>

    <section style="margin-top:24px;">
      <h2>üîó Schnellzugriffe</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin:16px 0;">
        <button id="openTempraRemote" style="background:#30D058;">üéØ Tempra Remote √∂ffnen</button>
        <button id="openTempraStopwatch" style="background:#FF9500;">‚è±Ô∏è Tempra Stoppuhr √∂ffnen</button>
      </div>
    </section>

    <section style="margin-top:24px;">
      <h2>üìã API Beispiele</h2>
      <div id="apiExamples" style="background:#2a2a2a;padding:20px;border-radius:8px;font-family:monospace;font-size:14px;line-height:1.6;">
        Lade API Beispiele...
      </div>
    </section>
  </main>

<script>
  let currentToken = '';

  async function apiGet(url) {
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw await r.json().catch(()=>({ error: 'http '+r.status }));
    return r.json();
  }

  async function loadTokenInfo() {
    try {
      const data = await apiGet('/api/user/tokens');
      currentToken = data.token;
      
      const tokenInfo = document.getElementById('tokenInfo');
      tokenInfo.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <strong style="color:#30D058;">Token: ${data.token}</strong>
          <span style="color:#888;">Queue: ${data.queued}</span>
        </div>
        <div style="font-size:13px;color:#888;">
          Erstellt: ${new Date(data.createdAt).toLocaleString('de-DE')}
        </div>
        <div style="margin-top:12px;">
          <strong>Zuschauer URL:</strong><br>
          <a href="${data.apiExamples.spectatorUrl}" target="_blank" style="color:#30D058;word-break:break-all;">
            ${data.apiExamples.spectatorUrl}
          </a>
        </div>
      `;

      // API Examples
      const apiExamples = document.getElementById('apiExamples');
      apiExamples.innerHTML = `
<div style="margin-bottom:20px;">
  <strong style="color:#30D058;">üì§ Force senden (iOS Shortcuts / curl):</strong><br>
  <div style="background:#1a1a1a;padding:12px;border-radius:6px;margin:8px 0;">
POST ${data.apiExamples.pushForce.url}<br>
Content-Type: application/json<br><br>
{<br>
&nbsp;&nbsp;"force": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;"mode": "ms",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"target": 15,<br>
&nbsp;&nbsp;&nbsp;&nbsp;"trigger": "stop",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"minDurationMs": 3000,<br>
&nbsp;&nbsp;&nbsp;&nbsp;"app": "stopwatch"<br>
&nbsp;&nbsp;}<br>
}
  </div>
</div>

<div style="margin-bottom:20px;">
  <strong style="color:#FF9500;">üì• Queue abfragen:</strong><br>
  <div style="background:#1a1a1a;padding:12px;border-radius:6px;margin:8px 0;">
GET ${data.apiExamples.pollQueue.url}
  </div>
</div>

<div>
  <strong style="color:#FF453A;">‚úÖ Force best√§tigen:</strong><br>
  <div style="background:#1a1a1a;padding:12px;border-radius:6px;margin:8px 0;">
POST ${data.apiExamples.ackForce.url}<br>
Content-Type: application/json<br><br>
{"forceId": "FORCE_ID_FROM_QUEUE"}
  </div>
</div>
      `;

    } catch (e) {
      document.getElementById('tokenInfo').innerHTML = '<div style="color:#FF453A;">Fehler beim Laden der Token-Daten</div>';
      console.error(e);
    }
  }

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await fetch('/auth/logout', { method:'POST' });
    location.href = '/imperia/tempra/login.html';
  });

  document.getElementById('openTempraRemote').addEventListener('click', ()=> {
    if (!currentToken) return alert('Token noch nicht geladen');
    window.open(`/imperia/tempra/stopwatch.html?token=${encodeURIComponent(currentToken)}&mode=remote`, '_blank');
  });

  document.getElementById('openTempraStopwatch').addEventListener('click', ()=> {
    if (!currentToken) return alert('Token noch nicht geladen');
    window.open(`/imperia/tempra/stopwatch.html?token=${encodeURIComponent(currentToken)}`, '_blank');
  });

  // Init
  (async ()=> { await loadTokenInfo(); })();

  // Service Worker Registration
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('Service Worker registered with scope:', registration.scope);
    }).catch(function(err) {
      console.log('Service Worker registration failed:', err);
    });
  }
</script>
</body></html>
