<!doctype html>
<html lang="de">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Magier Dashboard</title>
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <main style="padding:18px;max-width:900px;margin:28px auto;">
    <h1>Dein Magier Dashboard</h1>
    <div style="margin-bottom:12px;">
      <button id="createTokenBtn">Neuen Token erzeugen</button>
      <button id="logoutBtn" style="margin-left:12px;">Logout</button>
    </div>

    <section style="margin-top:18px;">
      <h2>Deine Tokens</h2>
      <div id="tokensList">lade...</div>
    </section>

    <section style="margin-top:18px;">
      <h2>Schnelllinks</h2>
      <p>Wenn du einen Token auswählst, kannst du damit die Zuschauer-URL öffnen:</p>
      <input id="tokenForOpen" placeholder="Token ...">
      <button id="openSpectator">Zuschauer öffnen</button>
      <button id="openAdminStopwatch">Öffne Stoppuhr-Admin</button>
    </section>
  </main>

<script>
  async function apiGet(url) {
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw await r.json().catch(()=>({ error: 'http '+r.status }));
    return r.json();
  }
  async function apiPost(url, body) {
    const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if (!r.ok) throw await r.json().catch(()=>({ error: 'http '+r.status }));
    return r.json();
  }
  async function apiDel(url) {
    const r = await fetch(url, { method:'DELETE' });
    if (!r.ok) throw await r.json().catch(()=>({ error: 'http '+r.status }));
    return r.json();
  }

  async function refreshTokens() {
    try {
      const j = await apiGet('/api/user/tokens');
      const cont = document.getElementById('tokensList');
      cont.innerHTML = '';
      if (!j.tokens || j.tokens.length === 0) { cont.textContent = 'keine Tokens'; return; }
      j.tokens.forEach(t => {
        const el = document.createElement('div');
        el.style.padding = '8px';
        el.style.borderBottom = '1px solid rgba(255,255,255,0.06)';
        el.innerHTML = `<strong>${t.token}</strong> &nbsp; queued: ${t.queued} &nbsp; <button class="btnOpen">Öffnen</button> <button class="btnDel" style="margin-left:8px">Löschen</button>`;
        el.querySelector('.btnOpen').addEventListener('click', ()=> {
          window.open(`/spectator.html?token=${encodeURIComponent(t.token)}`, '_blank');
        });
        el.querySelector('.btnDel').addEventListener('click', async ()=> {
          if (!confirm('Token löschen?')) return;
          await apiDel(`/api/user/token/${encodeURIComponent(t.token)}`);
          refreshTokens();
        });
        cont.appendChild(el);
      });
    } catch (e) {
      document.getElementById('tokensList').textContent = 'Fehler beim Laden';
      console.error(e);
    }
  }

  document.getElementById('createTokenBtn').addEventListener('click', async ()=>{
    try {
      const j = await apiPost('/api/user/token', {});
      alert('Token erzeugt: ' + j.token);
      await refreshTokens();
    } catch (e) { alert('Fehler: ' + (e.error || JSON.stringify(e))); }
  });

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await fetch('/auth/logout', { method:'POST' });
    location.href = '/magician/login.html';
  });

  document.getElementById('openSpectator').addEventListener('click', ()=> {
    const t = document.getElementById('tokenForOpen').value.trim();
    if (!t) return alert('Token eingeben');
    window.open(`/spectator.html?token=${encodeURIComponent(t)}`, '_blank');
  });
  document.getElementById('openAdminStopwatch').addEventListener('click', ()=> {
    const t = document.getElementById('tokenForOpen').value.trim();
    if (!t) return alert('Token eingeben');
    window.open(`/magician/stopwatch-admin.html?token=${encodeURIComponent(t)}`, '_blank');
  });

  // init
  (async ()=> { await refreshTokens(); })();
</script>
</body></html>
